<!DOCTYPE html>
<html lang="en">
<head>

    <title>Single Page</title>
    <style>
    </style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
            getScriptOnce = (function (url, callback) {
                    var scriptArray = []; //array of urls
                    var scriptArrayLoading = []; //array of urls
                    return function (url, callback) {
                        //the array doesn't have such url
                        
                        if (scriptArray.indexOf(url) === -1 && scriptArrayLoading.indexOf(url) === -1) {
                            scriptArrayLoading.push(url);
                            if (typeof callback === 'function') {
                                return $.ajax({
                                    url: url,
                                    scriptCharset: "UTF-8",
                                    dataType: "script",
                                    cache: true
                                }).done(function (script, textStatus, jqXHR) {
                                    scriptArray.push(url);
                                    callback(script, textStatus, jqXHR);
                                }).always(function(){
                                    scriptArrayLoading.pop(url);
                                });
                            } else {
                                return $.ajax({
                                    url: url,
                                    scriptCharset: "UTF-8",
                                    dataType: "script",
                                    cache: true
                                }).done(function (script) {
                                    scriptArray.push(url);
                                }).always(function(){
                                    scriptArrayLoading.pop(url);
                                });
                            }
                        }
                        //the file is already there, it does nothing
                        //to support as of jQuery 1.5 methods .done().fail()
                        else {
                            return {
                                done: function () {
                                    return {
                                        fail: function () { }
                                    };
                                }
                            };
                        }
                    }
                }());
        var currentPage = 'arena';
        var historyMemory = {};
        var sectionLoadPrefix = "section";
        window.onpopstate = function (event) {
            goto(event.state.section);
        }
        async function goto(section) {
            let HTMLel = undefined;
            let load_fn = `load_${section}`;
            if (section === currentPage){
                return;
            }
            let el = document.getElementById('content');
            if (section in historyMemory){
                HTMLel = historyMemory[section].HTMLel;
            }else{
                HTMLel = document.createElement('div');
                HTMLel.id = 'content';
                $(HTMLel).load(`/${sectionLoadPrefix}/${section}`, () => {
                    //console.log("SECOND"); // Happens after FIRST. FYI.
                });
            }
            //console.log("FIRST"); // Happens before SECOND. FYI.
            unload_fn = `unload_${currentPage}`;
            if (unload_fn in window){
                window[unload_fn]();
            }
            el = el.parentElement.removeChild(el);
            historyMemory[currentPage] = { ...history.state, HTMLel: el }
            document.getElementById("container").appendChild(HTMLel);
            currentPage = section;
            if (load_fn in window) {
                window[load_fn]();
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            history.replaceState({ section: currentPage }, "", currentPage)
            document.querySelectorAll('a').forEach(a => {
                a.onclick = function () {
                    const section = this.dataset.section;
                    if(section === currentPage){
                        return false;
                    }
                    history.pushState({ section: section}, "", section);
                    const e = goto(section);
                    return false;
                };
            });
        });
    </script>
</head>
<body>
    <h1 id="load_status">Hello!</h1>
    <h1 id="unload_status">It's me!</h1>
    <a data-section="profile" href="">Profile</a>
    <a data-section="live" href="">Live</a>
    <a data-section="playback" href="">Playback</a>
    <div id="container"><div id="content"></div></div>
</body>
</html>